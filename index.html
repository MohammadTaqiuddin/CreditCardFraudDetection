<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fraud Demo — Supervisor UI</title>
  <style>
    /* General */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: #f5f7fa;
      color: #333;
    }

    h2 {
      text-align: center;
      color: #1a202c;
      margin-bottom: 10px;
    }

    p {
      text-align: center;
      font-size: 14px;
      margin-bottom: 20px;
      color: #555;
    }

    button {
      padding: 6px 12px;
      margin-right: 6px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    button:hover:not(:disabled) {
      transform: scale(1.05);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #loadBtn {
      background-color: #4caf50;
      color: white;
    }

    input {
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-left: 10px;
    }

    /* Table Styling */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
      transition: background 0.3s ease;
    }

    th {
      background: #1a73e8;
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: #f1f3f6;
    }

    .flag {
      background: #ffe6e6 !important;
      animation: flashRed 1s ease-in-out 2;
    }

    .ok {
      background: #e6ffe6 !important;
      animation: flashGreen 1s ease-in-out 1;
    }

    .score {
      font-weight: bold;
      text-align: center;
    }

    /* Alerts */
    #alerts {
      margin-top: 20px;
    }

    .alert {
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-weight: 500;
      animation: fadeIn 1s ease forwards;
    }

    .alert-danger {
      background: #ffdddd;
      color: #d8000c;
      border-left: 5px solid #d8000c;
    }

    .alert-success {
      background: #ddffdd;
      color: #4f8a10;
      border-left: 5px solid #4f8a10;
    }

    /* Animations */
    @keyframes flashRed {
      0% { background-color: #fff0f0; }
      50% { background-color: #ffcccc; }
      100% { background-color: #ffe6e6; }
    }

    @keyframes flashGreen {
      0% { background-color: #f0fff0; }
      50% { background-color: #ccffcc; }
      100% { background-color: #e6ffe6; }
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(-10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h2>Bank Supervisor — Transaction Review (Demo)</h2>
  <p>Click <b>Load</b> to fetch recent transactions. Click <b>Score</b> on a row to ask the model to evaluate. If flagged, use <b>Confirm</b> or <b>Block</b>.</p>
  <div style="text-align:center;">
    <button id="loadBtn">Load</button>
    <input id="limit" type="number" value="25" style="width:70px"/> recent
  </div>
  <div id="alerts"></div>
  <table id="txTable">
    <thead>
      <tr>
        <th>Txn ID</th><th>Time</th><th>Amount</th><th>Merchant</th>
        <th>Card Age</th><th>IP</th><th>DeviceRate</th><th>Score</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const backend = "http://127.0.0.1:8000";

async function load() {
  const limit = document.getElementById('limit').value || 25;
  const resp = await fetch(`${backend}/transactions?limit=${limit}`);
  const rows = await resp.json();
  const tbody = document.querySelector("#txTable tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.id = 'r'+r.txn_id;
    tr.innerHTML = `
      <td>${r.txn_id}</td>
      <td>${r.timestamp}</td>
      <td>₹${r.amount}</td>
      <td>${r.merchant_id}</td>
      <td>${r.card_age_days}</td>
      <td>${r.ip_country}</td>
      <td>${r.device_rate}</td>
      <td class="score">-</td>
      <td>
        <button onclick="score(${r.txn_id}, this)">Score</button>
        <button onclick="act(${r.txn_id}, 'confirm', this)" disabled>Confirm</button>
        <button onclick="act(${r.txn_id}, 'block', this)" disabled>Block</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function score(txn_id, btn) {
  btn.disabled = true;
  const tr = document.getElementById('r' + txn_id);
  const tds = tr.querySelectorAll('td');
  const payload = {
    txn_id: parseInt(tds[0].textContent),
    timestamp: tds[1].textContent,
    amount: parseFloat(tds[2].textContent.replace('₹','')),
    merchant_id: parseInt(tds[3].textContent),
    card_age_days: parseFloat(tds[4].textContent),
    card_country: 'IN',
    ip_country: tds[5].textContent,
    device_id: 123,
    hour: new Date().getHours(),
    device_rate: parseInt(tds[6].textContent)
  };
  const res = await fetch(`${backend}/score`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  const scoreCell = tr.querySelector('.score');
  const scorePercent = (json.score*100).toFixed(1);
  scoreCell.textContent = scorePercent + '%';

  // Mark row
  if (json.score >= 0.6) {
    tr.classList.add('flag');
    tr.classList.remove('ok');
  } else {
    tr.classList.add('ok');
    tr.classList.remove('flag');
  }

  // Enable confirm/block
  const btns = tr.querySelectorAll('button');
  btns.forEach(b => { if (b.textContent === 'Confirm' || b.textContent === 'Block') b.disabled = false; });

  // Show alert if score > 2%
  if (json.score > 0.02) {
    const alerts = document.getElementById('alerts');
    const msg = document.createElement('div');
    msg.className = 'alert alert-danger';
    msg.textContent = `⚠ Transaction ${txn_id} has a suspicious score of ${scorePercent}%!`;
    alerts.appendChild(msg);
    // auto-remove after 5 seconds
    setTimeout(() => msg.remove(), 5000);
  }
}

async function act(txn_id, actionType, button) {
  button.disabled = true;
  const form = new FormData();
  form.append('txn_id', txn_id);
  form.append('action', actionType);
  form.append('reason', actionType === 'block' ? 'Flagged by supervisor' : 'Supervisor confirmed');

  await fetch(`${backend}/action`, { method: 'POST', body: form });
  const alerts = document.getElementById('alerts');
  const msg = document.createElement('div');
  msg.className = 'alert ' + (actionType === 'block' ? 'alert-danger' : 'alert-success');
  msg.textContent = `Action: ${actionType} on txn ${txn_id} recorded.`;
  alerts.appendChild(msg);
  setTimeout(() => msg.remove(), 5000);
}

document.getElementById('loadBtn').addEventListener('click', load);
</script>
</body>
</html>
